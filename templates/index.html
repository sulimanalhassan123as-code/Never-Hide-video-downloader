<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Video Downloader</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f3f6fb;margin:0;padding:24px}
    .card{max-width:900px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(7,15,30,0.06)}
    input[type=text]{width:100%;padding:12px;border-radius:8px;border:1px solid #e3e7ef}
    button{background:#0b63ff;color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
    button:disabled{opacity:.6}
    .formats{margin-top:16px}
    .format-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f2f6}
    .meta{font-size:13px;color:#444}
    .small{font-size:12px;color:#666}
    .error{color:#b00020;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Advanced Video Downloader</h2>
    <p class="small">Paste a video URL (YouTube, TikTok, Instagram, X, Facebook …), get formats, and choose one to download.</p>

    <input id="videoUrl" type="text" placeholder="Paste video link here" />
    <div style="display:flex;margin-top:12px;gap:8px">
      <button id="fetchBtn">Get Formats</button>
      <button id="clearBtn" type="button">Clear</button>
    </div>

    <div id="status" class="small" style="margin-top:12px;display:none">Loading…</div>
    <div id="error" class="error" style="display:none"></div>

    <div id="formats" class="formats"></div>
  </div>

<script>
const fetchBtn = document.getElementById('fetchBtn')
const clearBtn = document.getElementById('clearBtn')
const urlInput = document.getElementById('videoUrl')
const formatsDiv = document.getElementById('formats')
const status = document.getElementById('status')
const errorEl = document.getElementById('error')

fetchBtn.addEventListener('click', async ()=>{
  const url = urlInput.value.trim()
  errorEl.style.display = 'none'
  formatsDiv.innerHTML = ''
  if(!url){ errorEl.textContent = 'Please enter a URL'; errorEl.style.display='block'; return }

  status.style.display = 'block'
  status.textContent = 'Fetching formats…'
  fetchBtn.disabled = true

  try{
    const res = await fetch(`/api/info?url=${encodeURIComponent(url)}`)
    if(!res.ok) throw new Error('Failed to fetch video data')
    const data = await res.json()
    if(data.error) throw new Error(data.error)

    status.style.display = 'none'

    const title = document.createElement('div')
    title.innerHTML = `<strong>${escapeHtml(data.title || 'Untitled')}</strong> <div class="small">by ${escapeHtml(data.uploader || '')}</div>`
    formatsDiv.appendChild(title)

    if(!data.formats || data.formats.length === 0){
      formatsDiv.appendChild(document.createTextNode('No formats found'))
      return
    }

    for(const f of data.formats){
      const div = document.createElement('div')
      div.className = 'format-item'

      const left = document.createElement('div')
      left.innerHTML = `<div class="meta">${escapeHtml(f.ext)} ${f.height ? f.height + 'p' : ''} ${f.format_note ? (' - ' + escapeHtml(f.format_note)) : ''}</div><div class="small">format: ${escapeHtml(f.format_id)} ${f.filesize ? ('- ' + formatBytes(f.filesize)) : ''}</div>`

      const right = document.createElement('div')
      const btn = document.createElement('button')
      btn.textContent = 'Download'
      btn.onclick = ()=>{ startDownload(url, f.format_id) }
      right.appendChild(btn)

      div.appendChild(left)
      div.appendChild(right)
      formatsDiv.appendChild(div)
    }

  }catch(e){
    errorEl.textContent = e.message
    errorEl.style.display='block'
    status.style.display = 'none'
  }finally{
    fetchBtn.disabled = false
  }
})

clearBtn.addEventListener('click', ()=>{
  urlInput.value = ''
  formatsDiv.innerHTML = ''
  errorEl.style.display = 'none'
})

function startDownload(url, format_id){
  const downloadUrl = `/download?url=${encodeURIComponent(url)}&format_id=${encodeURIComponent(format_id)}`
  window.location.href = downloadUrl
}

function formatBytes(bytes){
  if(!bytes) return ''
  const sizes = ['Bytes','KB','MB','GB','TB']
  if(bytes === 0) return '0 Byte'
  const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)), 10)
  return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i]
}

function escapeHtml(text){
  if(!text) return ''
  return text.replace(/[&"'<>]/g, function(c){
    return {'&':'&amp;','"':'&quot;',"'":'&#39;','<':'&lt;','>':'&gt;'}[c]
  })
}
</script>
</body>
  </html>
